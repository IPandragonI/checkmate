generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id
  username        String    @unique
  displayUsername String?
  name            String
  secondaryName   String?
  email           String    @unique
  emailVerified   Boolean   @default(false)
  image           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt
  sessions        Session[]
  accounts        Account[]

  elo           Int             @default(400)
  gamesWhite    Game[]          @relation("PlayerWhite")
  gamesBlack    Game[]          @relation("PlayerBlack")
  messages      ChatMessage[]
  ratingHistory RatingHistory[]

  preference UserPreference?

  @@map("User")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("Session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("Account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("Verification")
}

model Game {
  id            String  @id @default(uuid())
  code          String  @unique
  playerWhite   User?   @relation("PlayerWhite", fields: [playerWhiteId], references: [id])
  playerWhiteId String?
  playerBlack   User?   @relation("PlayerBlack", fields: [playerBlackId], references: [id])
  playerBlackId String?

  bot   Bot?    @relation(fields: [botId], references: [id])
  botId String?

  status GameStatus  @default(WAITING)
  result GameResult?

  timeMode      TimeMode @default(RAPID)
  timeLimit     Int?
  whiteTimeLeft Int?
  blackTimeLeft Int?

  createdAt  DateTime      @default(now())
  finishedAt DateTime?
  moves      Move[]
  messages   ChatMessage[]

  RatingHistory RatingHistory[]
}

model Move {
  id         String   @id @default(uuid())
  game       Game     @relation(fields: [gameId], references: [id])
  gameId     String
  moveNumber Int
  fromSquare String
  toSquare   String
  promotion  String?
  fen        String
  timestamp  DateTime @default(now())
}

model ChatMessage {
  id      String   @id @default(uuid())
  game    Game     @relation(fields: [gameId], references: [id])
  gameId  String
  user    User     @relation(fields: [userId], references: [id])
  userId  String
  message String
  sentAt  DateTime @default(now())
}

model RatingHistory {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  game      Game     @relation(fields: [gameId], references: [id])
  gameId    String
  oldElo    Int
  newElo    Int
  createdAt DateTime @default(now())
}

model UserPreference {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
  theme  String @default("bluechess")
}

model Bot {
  id        String   @id @default(uuid())
  name      String   @unique
  label     String
  elo       Int
  img       String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  games     Game[]
}

enum GameStatus {
  WAITING
  IN_PROGRESS
  FINISHED
}

enum GameResult {
  WHITE_WIN
  BLACK_WIN
  DRAW
  RESIGNATION
  TIMEOUT
  STALEMATE
  REPETITION
}

enum TimeMode {
  BULLET
  BLITZ
  RAPID
  CLASSICAL
}
