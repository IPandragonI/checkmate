generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id
  username        String    @unique
  displayUsername String?
  name            String
  secondaryName   String?
  email           String    @unique
  emailVerified   Boolean   @default(false)
  image           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt
  sessions        Session[]
  accounts        Account[]

  elo           Int             @default(400)
  gamesWhite    Game[]          @relation("PlayerWhite")
  gamesBlack    Game[]          @relation("PlayerBlack")
  messages      ChatMessage[]
  ratingHistory RatingHistory[]

  preference UserPreference?

  @@map("User")
  UserPuzzle UserPuzzle[]
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("Session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("Account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("Verification")
}

model Game {
  id            String  @id @default(uuid())
  code          String  @unique
  playerWhite   User?   @relation("PlayerWhite", fields: [playerWhiteId], references: [id])
  playerWhiteId String?
  playerBlack   User?   @relation("PlayerBlack", fields: [playerBlackId], references: [id])
  playerBlackId String?

  bot   Bot?    @relation(fields: [botId], references: [id])
  botId String?

  status   GameStatus  @default(WAITING)
  result   GameResult?
  winnerId String?

  timeMode      TimeMode @default(RAPID)
  timeLimit     Int?
  whiteTimeLeft Int?
  blackTimeLeft Int?

  currentFen     String @default("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")
  capturedPieces Json   @default("{\"white\":[],\"black\":[]}")

  createdAt  DateTime      @default(now())
  finishedAt DateTime?
  moves      Move[]
  messages   ChatMessage[]

  RatingHistory RatingHistory[]
}

model Move {
  id         String  @id @default(uuid())
  game       Game    @relation(fields: [gameId], references: [id])
  gameId     String
  moveNumber Int
  from       String
  to         String
  promotion  String?

  capturedPiece String?

  fen       String
  timestamp DateTime @default(now())

  @@index([gameId, moveNumber])
}

model ChatMessage {
  id      String   @id @default(uuid())
  game    Game     @relation(fields: [gameId], references: [id])
  gameId  String
  user    User     @relation(fields: [userId], references: [id])
  userId  String
  message String
  sentAt  DateTime @default(now())
}

model RatingHistory {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  game      Game     @relation(fields: [gameId], references: [id])
  gameId    String
  oldElo    Int
  newElo    Int
  createdAt DateTime @default(now())
}

model UserPreference {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
  theme  String @default("winter")
}

model Bot {
  id        String   @id @default(uuid())
  username  String   @unique
  label     String
  elo       Int
  img       String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  games     Game[]
}

model Puzzle {
  id       String @id @default(uuid())
  number   Int    @unique
  startFen String
  solution Json
  difficulty Int //1-5 scale
  createdAt DateTime @default(now())

  UserPuzzle UserPuzzle[]
}

model UserPuzzle {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  puzzle    Puzzle   @relation(fields: [puzzleId], references: [id])
  puzzleId  String
  attempts  Int      @default(0)
  solved    Boolean  @default(false)
  lastAttemptAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([userId, puzzleId])
}

enum GameStatus {
  WAITING
  IN_PROGRESS
  FINISHED
}

enum GameResult {
  WHITE_WIN
  BLACK_WIN
  DRAW
  RESIGNATION
  TIMEOUT
  STALEMATE
  REPETITION
}

enum TimeMode {
  BULLET
  BLITZ
  RAPID
  CLASSICAL
}
